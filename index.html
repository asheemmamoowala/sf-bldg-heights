<script src='https://api.mapbox.com/mapbox-gl-js/v0.35.1/mapbox-gl.js'></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v0.35.1/mapbox-gl.css' rel='stylesheet' />
<style>
    #features {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 300px;
        overflow: auto;
        background: rgba(255, 255, 255, 0.8);
    }
    
    #map canvas {
        cursor: crosshair;
    }
</style>
<div id='map' style='width: 100%; height: 100%;'></div>
<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiYXNoZWVtbSIsImEiOiJjajF0c3l1YWMwMDFlMzJsaG12amc0dXF3In0.L2SrgjgzM_1DoZIvTmhuUQ';
    var allowedHeightData = {
        "type": "FeatureCollection",
        "features": []
    };
    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/light-v9',
        zoom: 17,
         pitch: 45,
        // bearing: -17.6,
        center: [-122.4194, 37.7749]
    });
    map.setMaxBounds([[-122.514949713, 37.708090756], [-122.356969006, 37.8120157892]]);
    map.on('load', function () {
        map.addSource('sfheight', {
            type: 'vector',
            url: 'mapbox://asheemm.89ifztg3'
        });
        map.addSource('allowedHeight', {
            type: 'geojson',
            data: allowedHeightData
        });
        map.addLayer({
            'id': 'sf-heights',
            'source': 'sfheight',
            'source-layer': 'sfheights-03zip0',
            'type': 'fill',
            'minzoom': 13,
            'paint': {
                'fill-color': '#7eddfc',
                // 'fill-extrusion-height': {
                //     'type': 'identity',
                //     'property': 'height'
                // },
                // 'fill-extrusion-base': 0,
                'fill-opacity': .35
            }

        });
        map.addLayer({
            'id': '3d-buildings',
            'source': 'composite',
            'source-layer': 'building',
            'filter': ['==', 'extrude', 'true'],
            'type': 'fill-extrusion',
            'minzoom': 15,
            'paint': {
                'fill-extrusion-color': '#aaa',
                'fill-extrusion-height': {
                    'type': 'identity',
                    'property': 'height'
                },
                'fill-extrusion-base': {
                    'type': 'identity',
                    'property': 'min_height'
                },
                'fill-extrusion-opacity': .45
            }
        });
        map.addLayer({
            'id': 'allowed-height',
            'source': 'allowedHeight',
            'type': 'fill-extrusion',
            'minzoom': 16,
            'paint': {
                'fill-extrusion-color': '#58d1ab',
                'fill-extrusion-height': {
                    'type': 'identity',
                    'property': 'height'
                },
                'fill-extrusion-base': {
                    'type': 'identity',
                    'property': 'min_height'
                },
                'fill-extrusion-opacity': .25
            }
        });

        map.on('mousemove', '3d-buildings', function (e) {
            if (!e.features || map.getZoom() < 16.5)
                return;
            const highlightedFeature = e.features[0];
            // Only care about buildings with extrude/height data
            if (!highlightedFeature.properties.extrude)
                return;
            var bulkHeightZones = map.queryRenderedFeatures(e.point, { layers: ['sf-heights'] });
            if (!bulkHeightZones || !bulkHeightZones[0] || !bulkHeightZones[0].properties)
                return;
            const actualHeight = highlightedFeature.properties.height;
            const allowedHeight = bulkHeightZones[0].properties.height;
            if (allowedHeight - actualHeight > 3) { //tolerance for buildings close to allowed height
                highlightedFeature.properties.height = allowedHeight;
                allowedHeightData.features.push(highlightedFeature)
                map.getSource('allowedHeight').setData(allowedHeightData);
            }
        });
    });

</script>